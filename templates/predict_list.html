<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>쓰레기 카드형 리스트 - 최종 개선</title>
<style>
body { font-family: 'Arial', sans-serif; margin:0; padding:0; background:#f2f2f2; }
.container { width: 90%; max-width: 1200px; margin: 20px auto; position: relative; }

/* 카드 공통 */
.card { display: flex; border-radius: 12px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.1); padding: 10px; margin: 10px 0; transition: transform 0.2s;}
.card:hover { transform: translateY(-2px); }
.card img { width: 224px; height: 224px; object-fit: cover; border-radius: 8px; flex-shrink: 0; }
.card-content { flex: 1; margin-left: 15px; display: flex; flex-direction: column; gap: 8px; }

/* PC 카드 */
@media(min-width: 768px){
  .card { flex-direction: row; align-items: flex-start; }
  .content-box { background: #f9f9f9; padding: 8px 10px; border-radius: 8px; }
  .card-row { display: flex; align-items: center; margin-top:5px; gap:10px; }
  .card-row select { padding:5px; border-radius:6px; border:1px solid #ccc; }
  .card-row button.update-btn { padding:6px 12px; border:none; border-radius:6px; background:#4CAF50; color:white; cursor:pointer; transition:0.2s; }
  .card-row button.update-btn:hover { background:#45a049; }
}

/* 모바일 카드 */
@media(max-width: 767px){
  .card { flex-direction: row; cursor: pointer; align-items: flex-start; }
  .card img { width: 120px; height: 120px; }
  .card-content { margin-left: 10px; flex:1; gap:4px; }
  .card-row { display: flex; flex-direction: column; margin-top:5px; gap:5px; }
  .card-row select, .card-row button.update-btn { width: 100%; }
}

/* 모바일 모달 시트 */
.modal-sheet {
    position: fixed; left: 0; bottom: -100%; width: 100%; height: 65%; background: #fff;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.25); transition: bottom 0.3s; padding: 15px; 
    z-index: 9999; border-top-left-radius: 20px; border-top-right-radius: 20px; 
    box-sizing:border-box; overflow-y: auto; overflow-x: hidden;
    scrollbar-width: none; 
}
.modal-sheet::-webkit-scrollbar { display: none; }
.modal-sheet.show { bottom: 0; pointer-events: auto; }

/* 닫기 버튼 */
.modal-close {
    position: absolute; top: 0; left: 50%; transform: translateX(-50%);
    width: 60px; height: 10px; /* 높이 절반 */
    background: #ddd; border-radius: 20px; margin-top: 5px;
    pointer-events: none; /* 터치 무효화 */
}

/* 모달 내부 */
#modal-image { border-radius:10px; display:block; margin:20px auto 10px auto; max-width:100%; }
#modal-category, #modal-update-btn { margin-top: 10px; width: 100%; padding: 8px; border-radius: 6px; box-sizing: border-box; }
#modal-update-btn { background:#4CAF50; color:white; border:none; cursor:pointer; transition:0.2s; }
#modal-update-btn:hover { background:#45a049; }
#modal-guide { margin-top:10px; line-height:1.5; word-break:break-word; padding:5px; background:#f9f9f9; border-radius:8px; }

/* 모달 활성 시 배경 비활성화 */
body.modal-open .container { pointer-events: none; user-select: none; }

/* 내용 없을 때 메시지 */
#empty-message { display:none; text-align:center; margin-top:20px; color:#888; }
</style>
</head>
<body>
<div class="container" id="waste-container">
  <p id="empty-message">내용이 존재하지 않습니다.</p>
</div>

<!-- 모달 -->
<div class="modal-sheet" id="modal-sheet">
  <div class="modal-close"></div> <!-- 중앙 닫기 버튼 -->
  <img id="modal-image" src="" width="224" height="224">
  <select id="modal-category"></select>
  <button id="modal-update-btn">수정</button>
  <p id="modal-guide"></p>
</div>

<script>
let categories = [];

// 테스트 데이터 (비어있게 하려면 items=[];)
let items = [];
 page = 1;
const per_page = 20;

function renderCard(item){
  const card = document.createElement('div');
  card.className = 'card';
  card.dataset.id = item.id;

  const img = document.createElement('img');
  img.src = item.image_url;
  card.appendChild(img);

  const content = document.createElement('div');
  content.className = 'card-content';
            
  content.innerHTML = `
    <div class="content-box"><strong>예측결과:</strong> ${item.predicted_result}</div>
    <div class="content-box"><strong>분리수거 가이드:</strong> ${item.recycling_guide}</div>
    <div class="card-row">
      <select id='predicted_class_${item.id}'>predicted_class
        ${categories.map(c=>`<option value="${c.id}" ${c.id===item.id?'selected':''}>${c.name}</option>`).join('')}
      </select>
      <button class="update-btn" onclick="predicChange(${item.id})">수정</button>
    </div>
  `;
  card.appendChild(content);
  return card;
}

let loading = false;
async function codeLoad() {
    try {
        const response = await fetch("{% url 'code_list' %}");
        if (!response.ok) throw new Error("API 요청 실패");

        const data = await response.json();
        categories = data.codelist;  // 전역 변수에 저장

    } catch (err) {
        console.error(err);
    }
}
codeLoad()

async function predicChange(itemId) {
    try {

        const select = document.getElementById(`predicted_class_${itemId}`);
        if (!select) return;

        const selectedValue = parseInt(select.value); // 선택된 category_id
        const response = await fetch("{% url 'predict_class_change' %}?id="+itemId+"&group_code_id="+selectedValue);
        if (!response.ok) throw new Error("API 요청 실패");

        const data = await response.json();
        if(data.success !== true)
        {
            alert('실패 하였습니다.')
        }

    } catch (err) {
        console.error(err);
    }
}

async function loadData(){
  const container = document.getElementById('waste-container');
  const emptyMessage = document.getElementById('empty-message');

  if(loading) return;
  loading = true;

  try{
    const response = await fetch(`{% url 'predict_list' %}?page=${page}`);
    if(!response.ok) throw new Error("API 요청 실패");
    const data = await response.json(); // JSON 형식: { items: [...], has_more: true/false }

    if(page === 1 && data.items.length === 0){
      emptyMessage.style.display = 'block';
    } else {
      emptyMessage.style.display = 'none';
     
      data.items.forEach(item=>{
        container.appendChild(renderCard(item));
      });
      page++;
    }

    loading = false;

    // 더 이상 데이터 없으면 스크롤 이벤트 해제
    if(!data.has_more){
      window.removeEventListener('scroll', scrollHandler);
    }
  } catch(err){
    console.error(err);
    loading = false;
  }
}   

// 스크롤 핸들러
function scrollHandler(){
  if((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 300){
    loadData();
  }
}

window.addEventListener('scroll', scrollHandler);


// 무한 스크롤
// window.addEventListener('scroll', ()=>{
//   if((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 300){
//     if((page-1)*per_page < items.length){
//       loadData();
//     }
//   }
// });

// 모달 클릭
document.getElementById('waste-container').addEventListener('click', function(e){
  let card = e.target.closest('.card');
  if(!card) return;

  if(window.innerWidth < 768){
    const imgSrc = card.querySelector('img').src;
    const guide = card.querySelector('.card-content div:nth-child(2)').innerText;
    const categoryId = parseInt(card.querySelector('select').value);

    const modal = document.getElementById('modal-sheet');
    document.getElementById('modal-image').src = imgSrc;
    const select = document.getElementById('modal-category');
    select.innerHTML = categories.map(c=>`<option value="${c.id}" ${c.id===categoryId?'selected':''}>${c.name}</option>`).join('');
    document.getElementById('modal-guide').innerText = guide;

    modal.classList.add('show');
    document.body.style.overflow = 'hidden'; // 배경 스크롤 금지
    document.body.classList.add('modal-open'); // 배경 터치/클릭 금지
  }
});

// 모달 닫기
document.getElementById('modal-sheet').addEventListener('click', ()=>{
  document.getElementById('modal-sheet').classList.remove('show');
  document.body.style.overflow = '';
  document.body.classList.remove('modal-open');
});

loadData();
</script>
</body>
</html>
